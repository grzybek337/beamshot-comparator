<div id="compact-flashlight-tool">
    <style>
        #compact-flashlight-tool {
            background-color: #121212;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
            min-height: 400px;
            display: block;
            position: relative;
        }
        #compact-flashlight-tool * { box-sizing: border-box; }

        /* Grid */
        #compact-flashlight-tool .ft-container { display: flex; gap: 6px; width: 100%; flex-wrap: wrap; }
        #compact-flashlight-tool .ft-column { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 8px; }

        /* UI */
        #compact-flashlight-tool label { font-weight: bold; font-size: 1em; margin-bottom: 4px; display: block; }
        #compact-flashlight-tool select { width: 100%; padding: 8px; font-size: 14px; border-radius: 4px; border: 1px solid #444; background-color: #1f1f1f; color: #ffffff; cursor: pointer; }
        
        /* Cards */
        #compact-flashlight-tool .ft-card { background-color: #1f1f1f; border-radius: 6px; padding: 5px; border: 1px solid #333; }
        #compact-flashlight-tool .beam-container { width: 100%; height: 0; padding-bottom: 75%; position: relative; background-color: #000; border-radius: 3px; overflow: hidden; }
        #compact-flashlight-tool .beam-img-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* Navigation */
        #compact-flashlight-tool .nav-row { display: flex; gap: 4px; margin-top: 5px; }
        #compact-flashlight-tool .nav-btn { flex: 1; background-color: #333; color: #fff; border: 1px solid #444; padding: 3px 0; cursor: pointer; font-family: monospace; font-weight: bold; }
        #compact-flashlight-tool .nav-btn:hover { background-color: #444; }

        /* Loader */
        #compact-flashlight-tool .loader { border: 3px solid #333; border-top: 3px solid #fff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; position: absolute; top: 50%; left: 50%; margin: -15px 0 0 -15px; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Slider */
        #compact-flashlight-tool .slider-section { width: 100%; margin-top: 8px; padding-top: 15px; border-top: 1px solid #333; text-align: center;}
        #compact-flashlight-tool .wipe-outer-box { width: 100%; margin: 0 auto; position: relative; border-radius: 6px; overflow: hidden; border: 2px solid #444; height: 0; padding-bottom: 75%; cursor: col-resize; }
        #compact-flashlight-tool #c-wipe-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #compact-flashlight-tool #c-wipe-fg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; clip-path: inset(0 50% 0 0); }
        #compact-flashlight-tool .wipe-handle-line { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background-color: #fff !important; pointer-events: none; box-shadow: 0 0 5px rgba(0,0,0,0.8); }
        #compact-flashlight-tool .wipe-handle-circle { width: 20px; height: 20px; background-color: #fff !important; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 2px 6px rgba(0,0,0,0.6); }
        #compact-flashlight-tool .wipe-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: col-resize; margin: 0; }
        
        /* Checkbox */
        #compact-flashlight-tool .cb-container { display: flex; align-items: center; justify-content: center; margin-bottom: 10px; cursor: pointer; color: #ccc; }
        #compact-flashlight-tool .cb-container input { margin-right: 8px; cursor: pointer; }

        @media (max-width: 600px) { #compact-flashlight-tool { padding: 5px; } .ft-card { padding: 3px; } }
    </style>

    <div class="ft-container">
        <div class="ft-column">
            <label>Select Light 1:</label>
            <select id="c-light1" onchange="c_updateCard(1)"></select>
            <div class="ft-card">
                <div class="beam-container">
                    <div id="c-loader-1" class="loader"></div>
                    <img id="c-img-1" class="beam-img-content" src="">
                </div>
                <div class="nav-row">
                    <button class="nav-btn" onclick="c_cycleLight(1, -1)">&lt;</button>
                    <button class="nav-btn" onclick="c_cycleLight(1, 1)">&gt;</button>
                </div>
            </div>
        </div>
        
        <div class="ft-column">
            <label>Select Light 2:</label>
            <select id="c-light2" onchange="c_updateCard(2)"></select>
            <div class="ft-card">
                <div class="beam-container">
                    <div id="c-loader-2" class="loader"></div>
                    <img id="c-img-2" class="beam-img-content" src="">
                </div>
                <div class="nav-row">
                    <button class="nav-btn" onclick="c_cycleLight(2, -1)">&lt;</button>
                    <button class="nav-btn" onclick="c_cycleLight(2, 1)">&gt;</button>
                </div>
            </div>
        </div>

        <div class="slider-section">
            <label class="cb-container">
                <input type="checkbox" id="c-addLabels" checked onchange="c_updateCard(1); c_updateCard(2);"> 
                Show names
            </label>
            <div class="wipe-outer-box">
                <img id="c-wipe-bg" src=""><img id="c-wipe-fg" src="">
                <div id="c-wipe-line" class="wipe-handle-line"><div class="wipe-handle-circle"></div></div>
                <input type="range" min="0" max="100" value="50" class="wipe-input" id="c-wipe-slider" oninput="c_updateWipe()">
            </div>
        </div>
    </div>

    <script>
    (function() { // IIFE to prevent conflict with Main Comparator

        /* --- USER DATA START --- */
        const compactLightData = {
            "demo1": { 
                name: "Review Item: Acebeam L35", 
                image: "https://placehold.co/800x600/222/fff?text=Acebeam+L35" 
            },
            "demo2": { 
                name: "Competitor: Convoy L21B", 
                image: "https://placehold.co/800x600/444/fff?text=Convoy+L21B" 
            },
            "demo3": { 
                name: "Competitor: Sofirn C8G",  
                image: "https://placehold.co/800x600/666/fff?text=Sofirn+C8G" 
            }
        };
        /* --- USER DATA END --- */

        // Expose specific functions globally so HTML onchange works
        window.c_updateCard = function(idSuffix) {
            const selectBox = document.getElementById(`c-light${idSuffix}`);
            if (!selectBox || !selectBox.value) return;
            const data = compactLightData[selectBox.value];

            const imgEl = document.getElementById(`c-img-${idSuffix}`);
            const loaderEl = document.getElementById(`c-loader-${idSuffix}`);

            loaderEl.style.display = "block";
            imgEl.style.opacity = "0.5";

            imgEl.onload = function() {
                loaderEl.style.display = "none";
                imgEl.style.opacity = "1";
                drawTextOnPreview(imgEl, data);
            };
            imgEl.src = data.image;

            if (idSuffix === 1) { document.getElementById("c-wipe-fg").src = data.image; }
            else { document.getElementById("c-wipe-bg").src = data.image; }
        };

        window.c_cycleLight = function(idSuffix, direction) {
            const select = document.getElementById("c-light" + idSuffix);
            if (!select) return;
            let newIndex = select.selectedIndex + direction;
            const maxIndex = select.options.length - 1;
            if (newIndex < 0) newIndex = maxIndex;
            if (newIndex > maxIndex) newIndex = 0;
            select.selectedIndex = newIndex;
            window.c_updateCard(idSuffix);
        };

        window.c_updateWipe = function() {
            const slider = document.getElementById("c-wipe-slider");
            const percent = slider.value;
            document.getElementById("c-wipe-line").style.left = percent + "%";
            document.getElementById("c-wipe-fg").style.clipPath = `inset(0 ${100 - percent}% 0 0)`;
        };

        function initSystem() {
            populateDropdown("c-light1");
            populateDropdown("c-light2");
            window.c_updateCard(1);
            window.c_updateCard(2);
        }

        function populateDropdown(elementId) {
            const select = document.getElementById(elementId);
            const keys = Object.keys(compactLightData).sort((a, b) => compactLightData[a].name.localeCompare(compactLightData[b].name));
            select.innerHTML = "";
            keys.forEach(key => {
                const opt = document.createElement("option");
                opt.value = key;
                opt.innerText = compactLightData[key].name;
                select.appendChild(opt);
            });
            if (elementId === 'c-light2' && keys.length > 1) { select.selectedIndex = 1; }
        }

        function drawTextOnPreview(imgElement, data) {
            if (!document.getElementById("c-addLabels").checked) return;

            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = imgElement.naturalWidth;
            canvas.height = imgElement.naturalHeight;

            ctx.drawImage(imgElement, 0, 0);

            const fontSize = Math.max(14, Math.round(canvas.width * 0.02));
            const padding = fontSize * 0.5;
            const margin = fontSize;

            ctx.font = "bold " + fontSize + "px Arial";
            const textWidth = ctx.measureText(data.name).width;
            const boxWidth = textWidth + (padding * 2);
            const boxHeight = (fontSize * 1.2) + padding;

            ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
            ctx.fillRect(margin, margin, boxWidth, boxHeight);

            ctx.fillStyle = "#ffffff";
            ctx.textBaseline = "top";
            ctx.textAlign = "left";
            ctx.fillText(data.name, margin + padding, margin + padding);

            if (!imgElement.getAttribute("data-modified")) {
                imgElement.setAttribute("data-modified", "true");
                imgElement.src = canvas.toDataURL("image/jpeg", 0.9);
            } else {
                imgElement.removeAttribute("data-modified");
            }
        }

        setTimeout(initSystem, 200);

    })(); // End IIFE
    </script>
</div>

